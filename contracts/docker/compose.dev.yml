services:
  chain:
    image: node:20
    working_dir: /app
    command: sh -lc "npm ci && npx hardhat node --hostname 0.0.0.0"
    volumes:
      - ..:/app
    ports: ["8545:8545"]
    # более строгий healthcheck JSON-RPC:
    # test: ["CMD-SHELL", "node -e \"require('http').request({method:'POST',host:'localhost',port:8545,headers:{'content-type':'application/json'}},res=>process.exit(res.statusCode===200?0:1)).end(JSON.stringify({jsonrpc:'2.0',id:1,method:'eth_blockNumber',params:[]}))\""]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:8545',()=>process.exit(0)).on('error',()=>process.exit(1))\""]
      interval: 5s
      timeout: 3s
      retries: 30
    tty: true

  contracts:
    image: node:20
    working_dir: /app
    depends_on:
      chain:
        condition: service_healthy   # ✅ ждать готовности
    environment:
      # не обязательно, так как используем --network docker, но можно оставить
      HARDHAT_URL: http://chain:8545
    command: sh -lc "npm ci && npx hardhat run scripts/deploy-local.ts --network docker && npm run abi:export"
    volumes:
      - ..:/app

  ipfs:
    image: ipfs/kubo:latest
    environment:
      IPFS_PROFILE: server
    ports:
      - "5001:5001"
      - "8080:8080"
    volumes:
      - ipfs:/data/ipfs
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 10s
      timeout: 5s
      retries: 30

volumes:
  ipfs:
