services:
  chain:
    image: node:20
    working_dir: /app
    command: sh -lc "npm ci && npx hardhat node --hostname 0.0.0.0"
    volumes:
      - ..:/app
    ports: ["8545:8545"]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:8545',()=>process.exit(0)).on('error',()=>process.exit(1))\""]
      interval: 5s
    tty: true

  contracts:
    image: node:20
    working_dir: /app
    depends_on: [chain]
    command: sh -lc "npm ci && npx hardhat run scripts/deploy-local.ts --network localhost && npm run abi:export"
    volumes:
      - ..:/app

  ipfs:
    image: ipfs/kubo:latest
    environment:
      IPFS_PROFILE: server
    ports:
      - "5001:5001"   # API
      - "8080:8080"   # Gateway
    volumes:
      - ipfs:/data/ipfs
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 10s
      timeout: 5s
      retries: 30

volumes:
  ipfs:
