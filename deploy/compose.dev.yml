name: dfsp-dev

# --- НАСТРОЙКА ЛОГИРОВАНИЯ ---
# Создаем шаблон, чтобы применить его ко всем сервисам
x-logging: &default-logging
  driver: "local"
  options:
    max-size: "30m"
    max-file: "3"

x-backend-build: &backend-build
  context: ../backend
  dockerfile: Dockerfile

networks:
  dfsp-dev:
    driver: bridge
  caddy:
    external: true
    name: dfsp-prod_dfsp

services:
  db:
    image: postgres:17-alpine
    container_name: dfsp-db-dev
    logging: *default-logging  # <--- Применено
    env_file:
      - .env.dev
    environment:
      POSTGRES_USER: ${DB_USER:-dfsp}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dfsp}
      POSTGRES_DB: ${DB_NAME:-dfsp}
    ports:
      - "${DB_HOST_PORT:-55432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-dfsp} -d ${DB_NAME:-dfsp} -p 5432 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 30
      start_period: 30s
    tmpfs:
      - /var/lib/postgresql/data
    networks: [ dfsp-dev, caddy ]
    restart: unless-stopped

  migrator:
    image: ${REGISTRY_HOST:-registry.dfsp.app}/${SERVICE_BACKEND:-dfsp-backend}:${BRANCH_NAME_LOWER:-dev}
    build: *backend-build
    container_name: dfsp-migrator-dev
    logging: *default-logging  # <--- Применено
    restart: "no"
    env_file:
      - .env.dev
    environment:
      WAIT_FOR_TIMEOUT: 60
    command: >-
      bash -lc "./docker/entrypoint.sh migrate"
    volumes:
      - ./shared:/app/shared
    networks: [ dfsp-dev, caddy ]
    depends_on:
      db:
        condition: service_healthy

  chain:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: dfsp-anvil-dev
    logging: *default-logging  # <--- Применено
    env_file:
      - .env.dev
    environment:
      CHAIN_ID: ${CHAIN_ID:-31337}
      ANVIL_IP_ADDR: 0.0.0.0
    command:
      - anvil
      - --host
      - 0.0.0.0
      - --port
      - "8545"
      - --chain-id
      - "${CHAIN_ID:-31337}"
      - --base-fee
      - "0"
      - --block-time
      - "1"
      - --gas-limit
      - "30000000"
      - --mnemonic
      - "test test test test test test test test test test test junk"
      - --accounts
      - "20"
      - --balance
      - "1000000000000000000000"
      - --state
      - /chain/state.json
      - --dump-state
      - /chain/state.json
    ports:
      - "${CHAIN_HOST_PORT:-18545}:8545"
    networks: [ dfsp-dev, caddy ]
    restart: unless-stopped
    tmpfs:
      - /chain

  contracts:
    image: node:${NODE_VERSION:-22}
    container_name: dfsp-contracts-dev
    logging: *default-logging  # <--- Применено
    working_dir: /app
    depends_on:
      chain:
        condition: service_started
    environment:
      HARDHAT_URL: "${HARDHAT_URL:-http://chain:8545}"
      DEPLOY_OUT: "${DEPLOY_OUT:-/shared/deployment.json}"
      NPM_CONFIG_CACHE: /npm-cache
    command: >
      sh -lc "npm ci && \
              npx hardhat run scripts/deploy-local.ts --network docker && \
              npm run abi:export && npm run export:deployment"
    volumes:
      - ../contracts/package.json:/app/package.json:ro
      - ../contracts/package-lock.json:/app/package-lock.json:ro
      - ../contracts/hardhat.config.ts:/app/hardhat.config.ts:ro
      - ../contracts/tsconfig.json:/app/tsconfig.json:ro
      - ../contracts/src:/app/src:ro
      - ../contracts/scripts:/app/scripts:ro
      - ../contracts/deploy:/app/deploy
      - ../contracts/docker:/app/docker:ro
      - ./shared:/shared
    networks: [ dfsp-dev, caddy ]

  api:
    image: ${REGISTRY_HOST:-registry.dfsp.app}/${SERVICE_BACKEND:-dfsp-backend}:${BRANCH_NAME_LOWER:-dev}
    build: *backend-build
    container_name: dfsp-api-dev
    logging: *default-logging  # <--- Применено
    restart: unless-stopped
    env_file:
      - .env.dev
    environment:
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}
    ports:
      - "${API_HOST_PORT:-18000}:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - ./shared:/app/shared
    networks: [ dfsp-dev, caddy ]
    depends_on:
      migrator:
        condition: service_completed_successfully
      redis:
        condition: service_started
      chain:
        condition: service_started
      db:
        condition: service_healthy

  celery-worker:
    image: ${REGISTRY_HOST:-registry.dfsp.app}/${SERVICE_BACKEND:-dfsp-backend}:${BRANCH_NAME_LOWER:-dev}
    build: *backend-build
    container_name: dfsp-celery-worker-dev
    logging: *default-logging  # <--- Применено
    restart: unless-stopped
    env_file:
      - .env.dev
    command: >-
      uv run celery -A app.relayer:celery worker --loglevel=info --concurrency=${RELAYER_CONCURRENCY:-2} -Q ${RELAYER_HIGH_QUEUE:-relayer.high},${RELAYER_DEFAULT_QUEUE:-relayer.default}
    volumes:
      - ./shared:/app/shared
    networks: [ dfsp-dev ]
    depends_on:
      redis:
        condition: service_started
      chain:
        condition: service_started
      db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "true" ]
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 5s

  celery-beat:
    image: ${REGISTRY_HOST:-registry.dfsp.app}/${SERVICE_BACKEND:-dfsp-backend}:${BRANCH_NAME_LOWER:-dev}
    build: *backend-build
    container_name: dfsp-celery-beat-dev
    logging: *default-logging  # <--- Применено
    restart: unless-stopped
    env_file:
      - .env.dev
    command: >-
      uv run celery -A app.relayer:celery beat --loglevel=info
    volumes:
      - ./shared:/app/shared
    networks: [ dfsp-dev ]
    depends_on:
      redis:
        condition: service_started
      chain:
        condition: service_started
      db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "true" ]
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 5s

  telegram-bot:
    build:
      context: ../bot
      dockerfile: Dockerfile
    container_name: dfsp-telegram-bot-dev
    logging: *default-logging  # <--- Применено
    restart: unless-stopped
    env_file:
      - .env.dev
    environment:
      BOT_MODE: "${BOT_MODE:-dev}"
      BOT_TOKEN: "${BOT_TOKEN:-}"
      DFSP_API_URL: "${DFSP_API_URL:-http://api:8000}"
      DFSP_API_TOKEN: "${DFSP_API_TOKEN:-}"
      WEBHOOK_SECRET: "${WEBHOOK_SECRET:-dev_bot_secret}"
      PUBLIC_WEB_ORIGIN: "${PUBLIC_WEB_ORIGIN:-http://localhost:${VITE_PORT:-5173}}"
      REDIS_DSN: "${BOT_REDIS_DSN:-${REDIS_DSN:-redis://redis:6379/0}}"
      QUEUE_DSN: "${BOT_QUEUE_DSN:-${REDIS_DSN:-redis://redis:6379/0}}"
      BOT_DB_DSN: "${BOT_DB_DSN:-postgresql://dfsp:dfsp_dev@db:5432/dfsp_bot}"
      APP_HOST: "${BOT_APP_HOST:-0.0.0.0}"
      APP_PORT: "${BOT_APP_PORT:-8080}"
      PROM_PORT: "${BOT_PROM_PORT:-8001}"
      BOT_MESSAGES_DB_PATH: "${BOT_MESSAGES_DB_PATH:-/app/dfsp-bot.db}"
      BOT_DEFAULT_LANGUAGE: "${BOT_DEFAULT_LANGUAGE:-ru}"
    ports:
      - "${BOT_APP_PORT:-8080}:8080"
      - "${BOT_PROM_PORT:-8001}:8001"
    volumes:
      - ../bot/app:/app/app
      - ../bot/pyproject.toml:/app/pyproject.toml
      - ../bot/uv.lock:/app/uv.lock
    depends_on:
      api:
        condition: service_started
      redis:
        condition: service_started
      db:
        condition: service_healthy
    networks: [ dfsp-dev, caddy ]

  redis:
    image: redis:7.2-alpine
    container_name: dfsp-redis-dev
    logging: *default-logging  # <--- Применено
    restart: unless-stopped
    ports:
      - "${REDIS_HOST_PORT:-56379}:6379"
    tmpfs:
      - /data
    networks: [ dfsp-dev ]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s

  ipfs:
    image: ipfs/kubo:${IPFS_VERSION:-latest}
    container_name: dfsp-ipfs-dev
    logging: *default-logging  # <--- Применено
    env_file:
      - .env.dev
    environment:
      IPFS_PROFILE: "${IPFS_PROFILE:-server}"
    ports:
      - "${IPFS_API_HOST_PORT:-5002}:5001"
      - "${IPFS_GATEWAY_HOST_PORT:-8082}:8080"
    tmpfs:
      - /data/ipfs
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 15s
    networks: [ dfsp-dev, caddy ]
    restart: unless-stopped

  nginx:
    image: nginx:1.27-alpine
    container_name: dfsp-nginx-dev
    logging: *default-logging  # <--- Применено
    ports:
      - "8081:80"
    volumes:
      - ../frontend/build:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks: [ dfsp-dev ]
    depends_on:
      api:
        condition: service_healthy
    profiles: [ "nginx" ]

  explorer-db:
    image: postgres:17-alpine
    container_name: blockscout-db-dev
    logging: *default-logging  # <--- Применено
    environment:
      POSTGRES_USER: blockscout
      POSTGRES_PASSWORD: ${EXPLORER_DB_PASSWORD:-blockpass}
      POSTGRES_DB: blockscout
    tmpfs:
      - /var/lib/postgresql/data
    networks: [ dfsp-dev ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blockscout -p 5432 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 30
      start_period: 30s

  explorer-indexer:
    image: ghcr.io/blockscout/blockscout:latest
    container_name: blockscout-indexer-dev
    logging: *default-logging  # <--- Применено
    working_dir: /app
    command: >
      sh -lc "
        bin/blockscout eval 'Elixir.Explorer.ReleaseTasks.create_and_migrate()' &&
        bin/blockscout start
      "
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://blockscout:${EXPLORER_DB_PASSWORD:-blockpass}@explorer-db:5432/blockscout
      ECTO_USE_SSL: "false"
      CHAIN_ID: ${CHAIN_ID:-31337}
      ETHEREUM_JSONRPC_VARIANT: anvil
      ETHEREUM_JSONRPC_HTTP_URL: http://chain:8545/
      ETHEREUM_JSONRPC_TRACE_URL: http://chain:8545/
      ETHEREUM_JSONRPC_WS_URL: ws://chain:8545/
      COIN: ETH
      LOG_LEVEL: debug
      INDEXER_ENABLE: "true"
      API_V2_ENABLED: "true"
      SECRET_KEY_BASE: ${BLOCKSCOUT_SECRET_KEY_BASE}
      PORT: 4000
      PHX_SERVER: "true"
      MIX_ENV: prod
    depends_on:
      explorer-db:
        condition: service_healthy
      chain:
        condition: service_started
    networks: [ dfsp-dev ]
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:4000/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  explorer-web:
    image: ghcr.io/blockscout/frontend:latest
    container_name: blockscout-web-dev
    logging: *default-logging  # <--- Применено
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_NETWORK_NAME: DFSP Devnet
      NEXT_PUBLIC_NETWORK_ID: ${CHAIN_ID:-31337}
      NEXT_PUBLIC_APP_HOST: explorer.dev.dfsp.app
      NEXT_PUBLIC_APP_PROTOCOL: https
      NEXT_PUBLIC_API_HOST: explorer.dev.dfsp.app
      NEXT_PUBLIC_API_PROTOCOL: https
      HOST: 0.0.0.0
      PORT: 3000
    depends_on:
      explorer-indexer:
        condition: service_started
    networks: [ dfsp-dev, caddy ]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 20s