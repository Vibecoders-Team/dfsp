# Caddy HTTPS reverse proxy for dfsp.app
# Assumes DNS A record for dfsp.app, rpc.dfsp.app, ipfs.dfsp.app point to this server.
# Provides automatic Let's Encrypt certificates.

{
  email admin@dfsp.app
}

# Apex: frontend + API proxy
_dfsp_common_headers {
  header {
    Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    X-Frame-Options "DENY"
    X-Content-Type-Options "nosniff"
    Referrer-Policy "no-referrer"
    Content-Security-Policy "default-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'"
  }
}

dfsp.app {
  import _dfsp_common_headers

  # Serve frontend static files (mounted volume)
  root * /usr/share/caddy/html
  file_server

  # API proxy (/api/*)
  handle_path /api/* {
    reverse_proxy api:8000
  }
}

# www redirect to apex
www.dfsp.app {
  redir https://dfsp.app{uri}
}

# Public HTTPS RPC endpoint (JSON-RPC over HTTP)
rpc.dfsp.app {
  import _dfsp_common_headers
  reverse_proxy chain:8545
}

# Public IPFS gateway
ipfs.dfsp.app {
  import _dfsp_common_headers
  reverse_proxy ipfs:8080
}

# Public Blockscout explorer
explorer.dfsp.app {
  import _dfsp_common_headers
  reverse_proxy explorer-web:3000
}
