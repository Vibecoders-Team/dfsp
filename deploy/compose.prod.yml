name: dfsp-prod

x-backend-build: &backend-build
  context: ../backend
  dockerfile: Dockerfile

networks:
  dfsp:
    driver: bridge

volumes:
  redis_data:
  shared:
  ipfs_data:
  pg_data:
  explorer_db:
  caddy_data:
  caddy_config:
  chain_data:


services:
  # ---------------- Database (Postgres) ----------------
  db:
    image: postgres:17-alpine
    container_name: dfsp-db
    env_file:
      - .env.prod
    environment:
      POSTGRES_USER: ${DB_USER:-dfsp}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dfsp}
      POSTGRES_DB: ${DB_NAME:-dfsp}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U dfsp -p 5432 || exit 1" ]
      interval: 15s
      timeout: 10s
      retries: 30
      start_period: 30s
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks: [ dfsp ]
    restart: unless-stopped

  # ---------------- Migrations ----------------
  migrator:
    image: dfsp-backend:prod
    build: *backend-build
    container_name: dfsp-migrator
    restart: "no"
    env_file:
      - .env.prod
    environment:
      WAIT_FOR_TIMEOUT: 60
    command: >-
      bash -lc "./docker/entrypoint.sh migrate"
    volumes:
      - ./shared:/app/shared
    networks: [ dfsp ]
    depends_on:
      db:
        condition: service_healthy

  # ---------------- Chain (own network) ----------------
  chain:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: dfsp-anvil
    environment:
      CHAIN_ID: ${CHAIN_ID:-31337}
      ANVIL_IP_ADDR: 0.0.0.0
    command:
      - anvil
      - --host
      - 0.0.0.0
      - --port
      - "8545"
      - --chain-id
      - "${CHAIN_ID:-31337}"
      - --base-fee
      - "0"
      - --block-time
      - "1"
      - --gas-limit
      - "30000000"
      - --mnemonic
      - "test test test test test test test test test test test junk"
      - --accounts
      - "20"
      - --balance
      - "1000000000000000000000"
      - --state
      - /chain/state.json
      - --dump-state
      - /chain/state.json
    ports:
      - "8545:8545"
    networks: [ dfsp ]
    restart: unless-stopped
    volumes:
      - chain_data:/chain

  # ---------------- Contracts deploy ----------------
  contracts:
    image: node:${NODE_VERSION:-22}
    container_name: dfsp-contracts
    working_dir: /app
    depends_on:
      chain:
        condition: service_started
    environment:
      HARDHAT_URL: "${HARDHAT_URL:-http://chain:8545}"
      DEPLOY_OUT: "${DEPLOY_OUT:-/shared/deployment.json}"
      NPM_CONFIG_CACHE: /npm-cache
    command: >
      sh -lc "npm ci && \
              npx hardhat run scripts/deploy-local.ts --network docker && \
              npm run abi:export && npm run export:deployment"
    volumes:
      - ../contracts/package.json:/app/package.json:ro
      - ../contracts/package-lock.json:/app/package-lock.json:ro
      - ../contracts/hardhat.config.ts:/app/hardhat.config.ts:ro
      - ../contracts/tsconfig.json:/app/tsconfig.json:ro
      - ../contracts/src:/app/src:ro
      - ../contracts/scripts:/app/scripts:ro
      - ../contracts/deploy:/app/deploy
      - ../contracts/docker:/app/docker:ro
      - ./shared:/shared
    networks: [ dfsp ]

  # ---------------- API ----------------
  api:
    image: dfsp-backend:prod
    build: *backend-build
    container_name: dfsp-api
    restart: unless-stopped
    env_file:
      - .env.prod
    environment:
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}
    ports:
      - "${API_PORT:-8000}:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - ./shared:/app/shared
    networks: [ dfsp ]
    depends_on:
      migrator:
        condition: service_completed_successfully
      redis:
        condition: service_started
      chain:
        condition: service_started
      db:
        condition: service_healthy

  # ---------------- Celery ----------------
  celery-worker:
    image: dfsp-backend:prod
    build: *backend-build
    container_name: dfsp-celery-worker
    restart: unless-stopped
    env_file:
      - .env.prod
    command: >-
      uv run celery -A app.relayer:celery worker --loglevel=info --concurrency=${RELAYER_CONCURRENCY:-2} -Q ${RELAYER_HIGH_QUEUE:-relayer.high},${RELAYER_DEFAULT_QUEUE:-relayer.default}
    volumes:
      - ./shared:/app/shared
    networks: [ dfsp ]
    depends_on:
      redis:
        condition: service_started
      chain:
        condition: service_started
      db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "true" ]
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 5s

  celery-beat:
    image: dfsp-backend:prod
    build: *backend-build
    container_name: dfsp-celery-beat
    restart: unless-stopped
    env_file:
      - .env.prod
    command: >-
      uv run celery -A app.relayer:celery beat --loglevel=info
    volumes:
      - ./shared:/app/shared
    networks: [ dfsp ]
    depends_on:
      redis:
        condition: service_started
      chain:
        condition: service_started
      db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "true" ]
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 5s

  # ---------------- Telegram Bot ----------------
  telegram-bot:
    build:
      context: ../bot
      dockerfile: Dockerfile
    container_name: dfsp-telegram-bot
    restart: unless-stopped
    env_file:
      - .env.prod
    environment:
      BOT_MODE: "${BOT_MODE:-prod}"
      BOT_TOKEN: "${BOT_TOKEN:-}"
      DFSP_API_URL: "${DFSP_API_URL:-http://api:8000}"
      DFSP_API_TOKEN: "${DFSP_API_TOKEN:-}"
      WEBHOOK_SECRET: "${WEBHOOK_SECRET:-bot_secret}"
      PUBLIC_WEB_ORIGIN: "${PUBLIC_WEB_ORIGIN:-https://dfsp.app}"
      REDIS_DSN: "${BOT_REDIS_DSN:-${REDIS_URL:-redis://redis:6379/0}}"
      QUEUE_DSN: "${BOT_QUEUE_DSN:-${REDIS_URL:-redis://redis:6379/0}}"
      APP_HOST: "${BOT_APP_HOST:-0.0.0.0}"
      APP_PORT: "${BOT_APP_PORT:-8080}"
      PROM_PORT: "${BOT_PROM_PORT:-8001}"
    ports:
      - "${BOT_APP_PORT:-8080}:8080"
      - "${BOT_PROM_PORT:-8001}:8001"
    depends_on:
      api:
        condition: service_started
      redis:
        condition: service_started
    networks: [ dfsp ]

  # ---------------- Redis ----------------
  redis:
    image: redis:7.2-alpine
    container_name: dfsp-redis
    restart: unless-stopped
    volumes: [ redis_data:/data ]
    networks: [ dfsp ]
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s

  # ---------------- IPFS ----------------
  ipfs:
    image: ipfs/kubo:${IPFS_VERSION:-latest}
    container_name: dfsp-ipfs
    env_file:
      - .env.prod
    environment:
      IPFS_PROFILE: "${IPFS_PROFILE:-server}"
    # no external port publish in prod; Caddy proxies internally
    # ports:
    #   - "${IPFS_API_HOST_PORT:-5001}:5001"
    #   - "${IPFS_GATEWAY_HOST_PORT:-8080}:8080"
    volumes:
      - ipfs_data:/data/ipfs
    healthcheck:
      test: [ "CMD", "ipfs", "id" ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 15s
    networks: [ dfsp ]
    restart: unless-stopped

  # ---------------- Reverse proxy (Caddy) ----------------
  caddy:
    image: caddy:2.8
    container_name: dfsp-caddy
    restart: unless-stopped
    env_file:
      - .env.prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../frontend/build:/usr/share/caddy/html:ro
      - ../frontend/build-dev:/usr/share/caddy/html-dev:ro
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks: [ dfsp ]
    depends_on:
      api:
        condition: service_started
      chain:
        condition: service_started
      ipfs:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1:80/health" ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s


  # ---------------- Nginx (optional, not used with Caddy) ----------------
  nginx:
    image: nginx:1.27-alpine
    container_name: dfsp-nginx
    ports:
      - "80:80"
    volumes:
      - ../frontend/build:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks: [ dfsp ]
    depends_on:
      api:
        condition: service_healthy
    profiles: [ "nginx" ]

  # ---------------- Blockscout Explorer ----------------
  explorer-db:
    image: postgres:17-alpine
    container_name: blockscout-db
    environment:
      POSTGRES_USER: blockscout
      POSTGRES_PASSWORD: ${EXPLORER_DB_PASSWORD:-blockpass}
      POSTGRES_DB: blockscout
    volumes:
      - explorer_db:/var/lib/postgresql/data
    networks: [ dfsp ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blockscout -p 5432 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 30
      start_period: 30s

  explorer-indexer:
    image: ghcr.io/blockscout/blockscout:latest
    container_name: blockscout-indexer
    working_dir: /app
    command: >
      sh -lc "
        bin/blockscout eval 'Elixir.Explorer.ReleaseTasks.create_and_migrate()' &&
        bin/blockscout start
      "
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://blockscout:${EXPLORER_DB_PASSWORD:-blockpass}@explorer-db:5432/blockscout
      ECTO_USE_SSL: "false"
      CHAIN_ID: ${CHAIN_ID:-31337}
      ETHEREUM_JSONRPC_VARIANT: anvil
      ETHEREUM_JSONRPC_HTTP_URL: http://chain:8545/
      ETHEREUM_JSONRPC_TRACE_URL: http://chain:8545/
      ETHEREUM_JSONRPC_WS_URL: ws://chain:8545/
      COIN: ETH
      LOG_LEVEL: debug
      INDEXER_ENABLE: "true"
      API_V2_ENABLED: "true"
      SECRET_KEY_BASE: ${BLOCKSCOUT_SECRET_KEY_BASE}
      PORT: 4000
      PHX_SERVER: "true"
      MIX_ENV: prod
    depends_on:
      explorer-db:
        condition: service_healthy
      chain:
        condition: service_started
    networks: [ dfsp ]
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://127.0.0.1:4000/api/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  explorer-web:
    image: ghcr.io/blockscout/frontend:latest
    container_name: blockscout-web
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_NETWORK_NAME: DFSP Localnet
      NEXT_PUBLIC_NETWORK_ID: ${CHAIN_ID:-31337}
      NEXT_PUBLIC_APP_HOST: explorer.dfsp.app
      NEXT_PUBLIC_APP_PROTOCOL: https
      NEXT_PUBLIC_API_HOST: explorer.dfsp.app
      NEXT_PUBLIC_API_PROTOCOL: https
      HOST: 0.0.0.0
      PORT: 3000
    depends_on:
      explorer-indexer:
        condition: service_started
    networks: [ dfsp ]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://$(hostname -i):3000 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 20s
