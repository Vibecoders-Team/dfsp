x-env-files: &env_files
  env_file:
    - path: ../../deploy/.env.dev
      required: false
    - path: ../../deploy/.env.local
      required: false

networks:
  dfsp:
    driver: bridge

volumes:
  pgdata: { }

services:
  # ----------- опциональная локальная БД (включается профилем localdb) ----------
  db:
    image: postgres:16-alpine
    container_name: db
    <<: *env_files
    entrypoint:
      - /bin/sh
      - -c
      - |
        export POSTGRES_USER="${DB_USER:-dfsp}";
        export POSTGRES_PASSWORD="${DB_PASSWORD:-dfsp}";
        export POSTGRES_DB="${DB_NAME:-dfsp}";
        exec /usr/local/bin/docker-entrypoint.sh postgres
    ports:
      - "${DB_HOST_PORT:-5432}:5432"
    healthcheck:
      test:
        [ "CMD-SHELL",
          "pg_isready -U $${DB_USER:-dfsp} -d $${DB_NAME:-dfsp} -p 5432" ]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks: [ dfsp ]
    profiles: [ "localdb" ]

  # ------------------------ Redis (по умолчанию включён) ------------------------
  redis:
    image: redis:7.2-alpine
    container_name: redis
    <<: *env_files
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [ dfsp ]

  # ------------------------ Миграции (run-once, опционально) --------------------
  migrator:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: migrator
    working_dir: /app
    <<: *env_files
    environment:
      ALEMBIC_AUTO_REVISION: "${ALEMBIC_AUTO_REVISION:-true}"
      WAIT_FOR_TIMEOUT: "${WAIT_FOR_TIMEOUT:-60}"

      # DB (если используем внешний Postgres — придут из env_file)
      DB_HOST: "${DB_HOST:-db}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_NAME: "${DB_NAME:-dfsp}"
      DB_USER: "${DB_USER:-dfsp}"
      DB_PASSWORD: "${DB_PASSWORD:-dfsp}"

      # Redis (можно переопределить REDIS_URL целиком)
      REDIS_URL: "${REDIS_URL:-redis://${REDIS_HOST:-redis}:${REDIS_PORT:-6379}/${REDIS_DB:-0}}"
    command:
      - bash
      - -lc
      - |
        export POSTGRES_DSN="postgresql+psycopg://$${DB_USER:-dfsp}:$${DB_PASSWORD:-dfsp}@$${DB_HOST:-dfsp-db}:$${DB_PORT:-5432}/$${DB_NAME:-dfsp}";
        export REDIS_URL="$${REDIS_URL:-redis://$${REDIS_HOST:-dfsp-redis}:$${REDIS_PORT:-6379}/$${REDIS_DB:-0}}";
        export WAIT_FOR_TIMEOUT="$${WAIT_FOR_TIMEOUT:-60}";
        ./docker/entrypoint.sh migrate
    volumes:
      - ../app:/app/app
      - ../migrations:/app/migrations
      - ../alembic.ini:/app/alembic.ini
    depends_on:
      redis:
        condition: service_healthy
      # db:
      #   condition: service_healthy
    restart: "no"
    networks: [ dfsp ]
    profiles: [ "migrate" ]

  # ----------------------------- API (uvicorn --reload) -------------------------
  api:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: api
    working_dir: /app
    <<: *env_files
    environment:
      # server
      API_HOST: "${API_HOST:-0.0.0.0}"
      API_PORT: "${API_PORT:-8000}"
      API_RELOAD: "${API_RELOAD:-true}"
      API_LOG_LEVEL: "${API_LOG_LEVEL:-info}"
      API_AUTO_MIGRATE: "${API_AUTO_MIGRATE:-false}"
      ALEMBIC_AUTO_REVISION: "${ALEMBIC_AUTO_REVISION:-true}"
      WAIT_FOR_TIMEOUT: "${WAIT_FOR_TIMEOUT:-60}"
      JWT_SECRET: "${JWT_SECRET:-change_me}"

      # DB
      DB_HOST: "${DB_HOST:-db}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_NAME: "${DB_NAME:-dfsp}"
      DB_USER: "${DB_USER:-dfsp}"
      DB_PASSWORD: "${DB_PASSWORD:-dfsp}"

      # Redis
      REDIS_URL: "${REDIS_URL:-redis://${REDIS_HOST:-redis}:${REDIS_PORT:-6379}/${REDIS_DB:-0}}"

      # Chain / IPFS / contracts (верхний compose может переопределить)
      CHAIN_RPC_URL: "${CHAIN_RPC_URL:-http://chain:8545}"
      CHAIN_ID: "${CHAIN_ID:-31337}"
      REGISTRY_CONTRACT_NAME: "${REGISTRY_CONTRACT_NAME:-FileRegistry}"
      CONTRACTS_DEPLOYMENT_JSON: "${CONTRACTS_DEPLOYMENT_JSON:-/app/shared/deployment.localhost.json}"
      IPFS_API_URL: "${IPFS_API_URL:-http://ipfs:5001/api/v0}"
      IPFS_GATEWAY_URL: "${IPFS_GATEWAY_URL:-http://ipfs:8080}"
      IPFS_PUBLIC_GATEWAY_URL: "${IPFS_PUBLIC_GATEWAY_URL:-http://localhost:8080}"
      CORS_ORIGINS: "${CORS_ORIGINS:-http://localhost:${VITE_PORT:-5173},http://127.0.0.1:${VITE_PORT:-5173}}"
    command:
      - bash
      - -lc
      - |
        export POSTGRES_DSN="postgresql+psycopg://$${DB_USER:-dfsp}:$${DB_PASSWORD:-dfsp}@$${DB_HOST:-dfsp-db}:$${DB_PORT:-5432}/$${DB_NAME:-dfsp}";
        export REDIS_URL="$${REDIS_URL:-redis://$${REDIS_HOST:-dfsp-redis}:$${REDIS_PORT:-6379}/$${REDIS_DB:-0}}";
        export API_HOST="$${API_HOST:-0.0.0.0}";
        export API_PORT="$${API_PORT:-8000}";
        export API_RELOAD="$${API_RELOAD:-true}";
        export API_LOG_LEVEL="$${API_LOG_LEVEL:-info}";
        export API_AUTO_MIGRATE="$${API_AUTO_MIGRATE:-false}";
        export WAIT_FOR_TIMEOUT="$${WAIT_FOR_TIMEOUT:-60}";
        export JWT_SECRET="$${JWT_SECRET:-change_me}";
        ./docker/entrypoint.sh api
    ports:
      - "${API_HOST_PORT:-8000}:8000"
    volumes:
      - ../app:/app/app
      - ../migrations:/app/migrations
      - ../alembic.ini:/app/alembic.ini
    depends_on:
      redis:
        condition: service_healthy
      # db:
      #   condition: service_healthy
      # migrator:
      #   condition: service_completed_successfully
    restart: unless-stopped
    networks: [ dfsp ]
