name: Deploy DFSP to Prod

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref to deploy (branch, tag, or SHA)
        required: false
        default: main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build frontend
        working-directory: frontend
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm install --frozen-lockfile
          pnpm build

      - name: Build backend image
        run: |
          docker build -t dfsp-backend:prod ./backend

      - name: Package artifacts
        run: |
          tar czf dfsp_artifacts.tgz frontend/build deploy Caddyfile || true
          echo "Artifacts packaged"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dfsp_artifacts
          path: dfsp_artifacts.tgz

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail
            mkdir -p ~/dfsp-deploy
            cd ~/dfsp-deploy

            # Fetch repo (or pull latest)
            if [ -d repo ]; then
              cd repo
              git fetch --all --tags
              git checkout ${{ github.event.inputs.ref || 'main' }}
              git pull --rebase
            else
              git clone --depth 1 --branch ${{ github.event.inputs.ref || 'main' }} ${{ secrets.REPO_SSH_URL }} repo
              cd repo
            fi

            # Write .env.prod from secrets (stored in GH env/organization secrets)
            cat > deploy/.env.prod <<'EOF'
${{ secrets.ENV_PROD }}
EOF

            # Ensure docker and compose installed
            docker --version
            docker compose version

            # Build backend image on server (or pull from registry if pushed)
            docker build -t dfsp-backend:prod ./backend

            # Build frontend on server (optional if shipped as artifact)
            cd frontend && corepack enable && corepack prepare pnpm@latest --activate && pnpm i && pnpm build && cd -

            # Deploy contracts (first time or when resetting local chain)
            docker compose -f deploy/compose.prod.yml --env-file deploy/.env.prod --profile contracts up --build --abort-on-container-exit || true

            # Migrate DB
            docker compose -f deploy/compose.prod.yml --env-file deploy/.env.prod --profile migrate up --build --abort-on-container-exit

            # Start/Update stack
            docker compose -f deploy/compose.prod.yml --env-file deploy/.env.prod up -d db redis chain ipfs api celery-worker celery-beat caddy

            # Health check
            sleep 5
            curl -fsS https://dfsp.app/api/health | jq . || true

      - name: Post status
        if: always()
        run: echo "Deploy finished with status ${{ job.status }}"

