name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  # ===========================
  # Create GitHub Release
  # ===========================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using initial commit"
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          echo "Generating changelog from $PREV_TAG to ${{ github.ref_name }}"
          
          # Generate changelog grouped by type
          {
            echo "## What's Changed"
            echo ""
            
            # Features
            FEATURES=$(git log --pretty=format:"%s" $PREV_TAG..${{ github.ref_name }} | grep -E '^feat(\(.+\))?:' || true)
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features"
              echo "$FEATURES" | sed 's/^/- /'
              echo ""
            fi
            
            # Fixes
            FIXES=$(git log --pretty=format:"%s" $PREV_TAG..${{ github.ref_name }} | grep -E '^fix(\(.+\))?:' || true)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES" | sed 's/^/- /'
              echo ""
            fi
            
            # Other changes
            OTHERS=$(git log --pretty=format:"%s" $PREV_TAG..${{ github.ref_name }} | grep -vE '^(feat|fix)(\(.+\))?:' || true)
            if [ -n "$OTHERS" ]; then
              echo "### ðŸ”§ Other Changes"
              echo "$OTHERS" | sed 's/^/- /'
              echo ""
            fi
            
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...${{ github.ref_name }}"
          } > CHANGELOG.md
          
          cat CHANGELOG.md
          
          # Save for next step
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================
  # Build and Upload Artifacts
  # ===========================
  build-artifacts:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        component: [frontend, contracts]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Build Frontend
        if: matrix.component == 'frontend'
        run: |
          cd frontend
          corepack enable
          corepack prepare pnpm@9 --activate
          pnpm install --frozen-lockfile
          pnpm run build
          tar -czf ../frontend-dist.tar.gz dist/

      - name: Build Contracts
        if: matrix.component == 'contracts'
        run: |
          cd contracts
          npm ci
          npm run build
          npm run abi:export
          tar -czf ../contracts-artifacts.tar.gz artifacts/ artifacts-abi/

      - name: Upload Frontend Artifact
        if: matrix.component == 'frontend'
        uses: softprops/action-gh-release@v1
        with:
          files: frontend-dist.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Contracts Artifact
        if: matrix.component == 'contracts'
        uses: softprops/action-gh-release@v1
        with:
          files: contracts-artifacts.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

