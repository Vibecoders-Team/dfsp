name: dfsp-dev

# общие env-файлы (dev → local override)
x-env-files: &env_files
  env_file:
    - path: ../../deploy/.env.dev
      required: false
    - path: ../../deploy/.env.local
      required: false

services:
  web:
    image: node:${NODE_VERSION:-20}
    container_name: web
    working_dir: /app
    command: >
      sh -lc "corepack enable &&
              corepack prepare pnpm@${PNPM_VERSION:-latest} --activate &&
              pnpm install --frozen-lockfile &&
              pnpm run dev -- --host 0.0.0.0"
    environment:
      CI: "${CI:-true}"
      VITE_API_BASE: "${VITE_API_BASE:-http://localhost:${API_HOST_PORT:-8000}}"
      VITE_IPFS_PUBLIC_GATEWAY: "${VITE_IPFS_PUBLIC_GATEWAY:-http://localhost:8080}"
      VITE_CHAIN_ID: "${VITE_CHAIN_ID:-${CHAIN_ID:-31337}}"
      VITE_CHAIN_RPC_URL: "${VITE_CHAIN_RPC_URL:-https://hardhat.localhost:8546}"
      VITE_CHAIN_PUBLIC_RPC_URL: "${VITE_CHAIN_PUBLIC_RPC_URL:-https://hardhat.localhost:8546}"
      PNPM_STORE_DIR: /pnpm-store
      VITE_WALLETCONNECT_PROJECT_ID: "${VITE_WALLETCONNECT_PROJECT_ID:-}"
    ports:
      - "${VITE_PORT:-5173}:5173"
    # ВАЖНО: /app — это volume (держит node_modules и dist),
    # а исходники точечно монтируются поверх
    volumes:
      - web_app:/app
      - web_pnpm_store:/pnpm-store
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/package.json:/app/package.json
      - ./frontend/pnpm-lock.yaml:/app/pnpm-lock.yaml
      - ./frontend/index.html:/app/index.html
      # если у тебя конфиг Vite называется vite.config.ts — раскомментируй строку ниже
      - ./frontend/vite.config.ts:/app/vite.config.ts
      # если конфиг eslint/prettier нужен внутри контейнера — добавь аналогично:
      - ./frontend/.eslintrc.cjs:/app/.eslintrc.cjs
      - ./frontend/eslint.config.js:/app/eslint.config.js
    depends_on:
      api:
        condition: service_started
    networks: [ dfsp ]
  # -------------------- backend: db/redis/migrator/api --------------------
  db:
    extends:
      file: ./backend/docker/compose.backend.yml
      service: db
    <<: *env_files
    networks: [ dfsp ]
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${DB_HOST_PORT:-5432}:5432"
    profiles: [ "localdb" ]

  redis:
    extends:
      file: ./backend/docker/compose.backend.yml
      service: redis
    <<: *env_files
    networks: [ dfsp ]
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"

  migrator:
    extends:
      file: ./backend/docker/compose.backend.yml
      service: migrator
    <<: *env_files
    networks: [ dfsp ]
    # важное: переопределяем пути на корневые
    volumes:
      - ./backend/app:/app/app
      - ./backend/migrations:/app/migrations
      - ./backend/alembic.ini:/app/alembic.ini
    environment:
      ALEMBIC_AUTO_REVISION: "${ALEMBIC_AUTO_REVISION:-true}"
    depends_on:
      redis:
        condition: service_healthy
      # db:
      #   condition: service_healthy
    profiles: [ "migrate" ]

  api:
    extends:
      file: ./backend/docker/compose.backend.yml
      service: api
    <<: *env_files
    networks: [ dfsp ]
    ports:
      - "${API_HOST_PORT:-8000}:8000"
    volumes:
      - ./backend/app:/app/app
      - ./backend/migrations:/app/migrations
      - ./backend/alembic.ini:/app/alembic.ini
      - ./backend/tests:/app/tests
      - shared:/app/shared
    environment:
      API_AUTO_MIGRATE: "${API_AUTO_MIGRATE:-false}"
      ALEMBIC_AUTO_REVISION: "${ALEMBIC_AUTO_REVISION:-true}"
      CHAIN_RPC_URL: "${CHAIN_RPC_URL:-http://chain:8545}"
      CHAIN_ID: "${CHAIN_ID:-31337}"
      CHAIN_PUBLIC_RPC_URL: "${CHAIN_PUBLIC_RPC_URL:-https://hardhat.localhost:8546}"
      CONTRACTS_DEPLOYMENT_JSON: "${CONTRACTS_DEPLOYMENT_JSON:-/app/shared/deployment.localhost.json}"
      REGISTRY_CONTRACT_NAME: "${REGISTRY_CONTRACT_NAME:-FileRegistry}"
      IPFS_PUBLIC_GATEWAY_URL: "${IPFS_PUBLIC_GATEWAY_URL:-http://localhost:8080}"
      IPFS_API_URL: "${IPFS_API_URL:-http://ipfs:5001/api/v0}"
      IPFS_GATEWAY_URL: "${IPFS_GATEWAY_URL:-http://ipfs:8080}"
      CORS_ORIGINS: "${CORS_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
      CHAIN_TX_FROM: "${CHAIN_TX_FROM:-}"
      # New DevOps envs
      RELAYER_HIGH_QUEUE: "${RELAYER_HIGH_QUEUE:-relayer.high}"
      RELAYER_DEFAULT_QUEUE: "${RELAYER_DEFAULT_QUEUE:-relayer.default}"
      QUOTA_META_TX_PER_DAY: "${QUOTA_META_TX_PER_DAY:-50}"
      QUOTA_DOWNLOAD_BYTES_PER_DAY: "${QUOTA_DOWNLOAD_BYTES_PER_DAY:-2147483648}"
      POW_DIFFICULTY_BASE: "${POW_DIFFICULTY_BASE:-18}"
      RELAYER_SYNC_DEV: "${RELAYER_SYNC_DEV:-1}"
    depends_on:
      redis:
        condition: service_healthy
      #migrator:
      #  condition: service_completed_successfully
      contracts:
        condition: service_completed_successfully
      ipfs:
        condition: service_healthy

  celery-worker:
    extends:
      file: ./backend/docker/compose.backend.yml
      service: celery-worker
    <<: *env_files
    networks: [ dfsp ]
    volumes:
      - ./backend/app:/app/app
      - ./backend/migrations:/app/migrations
      - ./backend/alembic.ini:/app/alembic.ini
      - ./backend/tests:/app/tests
      - shared:/app/shared
    environment:
      CHAIN_RPC_URL: "${CHAIN_RPC_URL:-http://chain:8545}"
      CHAIN_ID: "${CHAIN_ID:-31337}"
      CONTRACTS_DEPLOYMENT_JSON: "${CONTRACTS_DEPLOYMENT_JSON:-/app/shared/deployment.localhost.json}"
      REGISTRY_CONTRACT_NAME: "${REGISTRY_CONTRACT_NAME:-FileRegistry}"
      RELAYER_PRIVATE_KEY: "${RELAYER_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}"
      RELAYER_HIGH_QUEUE: "${RELAYER_HIGH_QUEUE:-relayer.high}"
      RELAYER_DEFAULT_QUEUE: "${RELAYER_DEFAULT_QUEUE:-relayer.default}"
      RELAYER_SYNC_DEV: "${RELAYER_SYNC_DEV:-1}"
    depends_on:
      redis:
        condition: service_healthy
      contracts:
        condition: service_completed_successfully

  # ---------------------- contracts: chain/contracts/ipfs ----------------------
  chain:
    extends:
      file: ./contracts/docker/compose.dev.yml
      service: chain
    volumes:
      - contracts_app:/app
      - ./contracts/package.json:/app/package.json
      - ./contracts/package-lock.json:/app/package-lock.json
      - ./contracts/hardhat.config.ts:/app/hardhat.config.ts
      - ./contracts/tsconfig.json:/app/tsconfig.json
      - ./contracts/src:/app/src
      - ./contracts/scripts:/app/scripts
      - ./contracts/test:/app/test
      - ./contracts/deploy:/app/deploy
      - ./contracts/docker:/app/docker
      - contracts_npm_cache:/npm-cache
      - shared:/app/shared
    networks: [ dfsp ]
    ports:
      - "${CHAIN_HOST_PORT:-8545}:8545"

  contracts:
    extends:
      file: ./contracts/docker/compose.dev.yml
      service: contracts
    networks: [ dfsp ]
    volumes:
      - contracts_app:/app
      - ./contracts/package.json:/app/package.json
      - ./contracts/package-lock.json:/app/package-lock.json
      - ./contracts/hardhat.config.ts:/app/hardhat.config.ts
      - ./contracts/tsconfig.json:/app/tsconfig.json
      - ./contracts/src:/app/src
      - ./contracts/scripts:/app/scripts
      - ./contracts/test:/app/test
      - ./contracts/deploy:/app/deploy
      - ./contracts/docker:/app/docker
      - shared:/shared
      - contracts_npm_cache:/npm-cache
    depends_on:
      chain:
        condition: service_healthy
    environment:
      HARDHAT_URL: "${HARDHAT_URL:-http://chain:8545}"
      DEPLOY_OUT: "${DEPLOY_OUT:-/shared/deployment.localhost.json}"
      CHAIN_CONFIG_PATH: "${CHAIN_CONFIG_PATH:-/app/deploy/chain-config.json}"
      NPM_CONFIG_CACHE: /npm-cache
    command: >
      sh -lc "npm ci &&
              npx hardhat run scripts/deploy-local.ts --network docker &&
              npm run abi:export && npm run export:deployment"

  ipfs:
    extends:
      file: ./contracts/docker/compose.dev.yml
      service: ipfs
    networks: [ dfsp ]
    ports:
      - "${IPFS_API_HOST_PORT:-5001}:5001"
      - "${IPFS_GATEWAY_HOST_PORT:-8080}:8080"
    volumes:
      - ipfs:/data/ipfs

  # ---------------------- Observability: Prometheus & Grafana ----------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: dfsp-prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=7d
      - --web.enable-lifecycle
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "${PROM_HOST_PORT:-9090}:9090"
    depends_on:
      api:
        condition: service_started
    networks: [ dfsp ]

  grafana:
    image: grafana/grafana:latest
    container_name: dfsp-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "${GRAFANA_HOST_PORT:-3001}:3000"
    depends_on:
      prometheus:
        condition: service_started
    networks: [ dfsp ]

  rpc_https:
    image: caddy:2.7
    container_name: hardhat-https
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile:ro
    ports:
      - "8546:8546"
    depends_on:
      - chain
    networks: [ dfsp ]
    healthcheck:
      test: ["CMD-SHELL","wget -qO- http://localhost:8546 -S --spider 2>&1 | grep -q 'HTTP/'"]
      interval: 5s
      timeout: 3s
      retries: 20

  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok-rpc
    environment:
      NGROK_AUTHTOKEN: "${NGROK_AUTH_TOKEN:-}"
    command: ["http", "--log=stdout", "--region=${NGROK_REGION:-eu}", "http://rpc_https:8546"]
    depends_on:
      rpc_https:
        condition: service_healthy
    ports:
      - "4040:4040"
    networks: [ dfsp ]

networks:
  dfsp:
    driver: bridge

volumes:
  pgdata: { }
  redis_data: { }
  ipfs: { }
  shared: { }
  web_pnpm_store: { }
  contracts_npm_cache: { }
  web_app: { }
  contracts_app: { }
  prometheus_data: { }
  grafana_data: { }
